<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Propiedades</title>

    <meta property="og:url" content="https://arribate.com/admin/properties/add/" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="ArríbaTe | Administrador" />
    <meta property="og:description" content="Agregar Propiedad" />
    <meta property="og:image" content="https://arribate.com/img/og_image_1.jpg" />


    <link rel="stylesheet" href="./css/styles.css" />
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, where } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBRjDso4IPrh9WLvWWMYoPiJxNFD6Vt3RU",
            authDomain: "arribate-com.firebaseapp.com",
            projectId: "arribate-com",
            storageBucket: "arribate-com.firebasestorage.app",
            messagingSenderId: "46945634270",
            appId: "1:46945634270:web:c74fd6781ac1fab5da7f4f",
            measurementId: "G-Y4J11MBYKQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        let correoUsuario = "";
        let orderedImages = [];



        // Configuración de tiempo de inactividad en milisegundos (10 minutos = 600000 ms)
        const tiempoInactividad = 6000000;
        let temporizadorInactividad;

        // Función para redirigir al usuario tras la inactividad
        function cerrarPorInactividad() {
            signOut(auth).then(() => {
                window.location.href = "./auth.html";
            }).catch((error) => {
                console.error("Error al cerrar sesión por inactividad: ", error);
            });
        }

        // Función para resetear el temporizador
        function resetearTemporizador() {
            clearTimeout(temporizadorInactividad);
            temporizadorInactividad = setTimeout(cerrarPorInactividad, tiempoInactividad);
        }



        // Verificar si el usuario está autenticado y obtener su nombre o correo
        onAuthStateChanged(auth, (user) => {
            const contentDiv = document.getElementById("content");
            if (user) {
                // Mostrar el contenedor solo si el usuario está autenticado
                contentDiv.style.display = "flex";
                const welcomeMessage = document.getElementById("welcome-message");
                let userName;

                if (user.displayName) {
                    userName = user.displayName;
                } else if (user.email) {
                    const emailNamePart = user.email.split('@')[0].split('.')[0];
                    userName = emailNamePart.toUpperCase();
                } else {
                    userName = "Usuario";
                }

                // Usar innerHTML para interpretar HTML en el mensaje
                welcomeMessage.innerHTML = `HOLA, <br><span style="font-weight: bold;">${userName}</span>`;
                correoUsuario = user.email;
            } else {
                // Redirigir solo si el usuario no está autenticado
                window.location.href = "./auth.html";
            }
        });



        // Función para obtener el siguiente ID
        async function generarID(categoria, tipoPropiedad) {
            const letraInicial = categoria === "venta" ? "v" : "a";
            const letraTipo = {
                casa: "c",
                apartamento: "a",
                terreno: "t",
                local: "l",
                oficina: "o",
                villa: "v",
                finca: "f",
                nave: "n",
                nagocio: "ng",
                penthouse: "p",
                edificio: "e"
            }[tipoPropiedad];

            const prefijo = `${letraInicial}${letraTipo}`;
            const propiedadesRef = collection(db, categoria === "venta" ? "ventas" : "alquileres");

            const q = query(
                propiedadesRef,
                where("id", ">=", prefijo),
                where("id", "<", prefijo + "~"),
                orderBy("id", "desc"),
                limit(1)
            );

            const querySnapshot = await getDocs(q);
            let siguienteNumero;

            if (querySnapshot.empty) {
                // Si no hay documentos, comenzamos con 10001
                siguienteNumero = 10001;
            } else {
                // Si hay documentos, obtenemos el último ID y sumamos 1
                querySnapshot.forEach((doc) => {
                    const ultimoID = doc.data().id;
                    const numeroActual = parseInt(ultimoID.slice(2));
                    siguienteNumero = numeroActual + 1;
                });
            }

            return `${prefijo}${String(siguienteNumero).padStart(5, "0")}`;
        }

        // Función para manejar cambios en el formulario
        async function actualizarID() {
            const categoria = document.getElementById("categoria").value;
            const tipoPropiedad = document.getElementById("tipoPropiedad").value;

            if (categoria && tipoPropiedad) {
                const idGenerado = await generarID(categoria, tipoPropiedad);
                document.getElementById("idPropiedad").value = idGenerado;

                // Actualizar la carpeta de imágenes automáticamente
                const imageFolderPath = `propiedades/${idGenerado}/img/`;
                document.getElementById("imageFolder").value = imageFolderPath;
            }
        }

        // Función para obtener la fecha actual en formato día/mes/año hora:minuto:segundo
        function obtenerFechaActual() {
            const fecha = new Date();
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const año = fecha.getFullYear();
            const hora = String(fecha.getHours()).padStart(2, '0');
            const minuto = String(fecha.getMinutes()).padStart(2, '0');
            const segundo = String(fecha.getSeconds()).padStart(2, '0'); // Agregar segundos
            return `${dia}/${mes}/${año} ${hora}:${minuto}:${segundo}`; // Incluir segundos en la cadena de retorno
        }


        let isSubmitting = false;

        async function agregarPropiedad(e) {
            e.preventDefault();

            // Verificar si ya se está enviando
            if (isSubmitting) return;

            isSubmitting = true; // Iniciar el proceso de envío
            document.querySelector('.slider-button').disabled = true; // Deshabilitar el botón de envío

            const categoria = document.getElementById("categoria").value;
            const tipoPropiedad = document.getElementById("tipoPropiedad").value;
            let idPropiedad = document.getElementById("idPropiedad").value;

            // Verificar y generar el ID actual al momento de guardar
            const idGenerado = await generarID(categoria, tipoPropiedad);
            if (idPropiedad !== idGenerado) {
                idPropiedad = idGenerado;
                document.getElementById("idPropiedad").value = idPropiedad;
            }

            // Asignar la ruta de la carpeta de imágenes con el ID actualizado
            const imageFolder = `propiedades/${idPropiedad}/img/`;
            document.getElementById("imageFolder").value = imageFolder;

            const area = parseInt(document.getElementById("area").value);
            const bathrooms = parseInt(document.getElementById("bathrooms").value);
            const rooms = parseInt(document.getElementById("rooms").value);
            const icon = document.getElementById("icon").value;
            const latLng = document.getElementById("latLng").value;
            const parking = parseInt(document.getElementById("parking").value);
            const price = parseInt(document.getElementById("price").value);
            const title = document.getElementById("title").value;
            const caracteristicas = document.getElementById("caracteristicas").value;
            const imageCount = parseInt(document.getElementById("imageCount").value);
            const mostrar = document.getElementById("mostrar").checked;
            const encargado = document.getElementById("encargado").value;
            const nombreEncargado = document.getElementById("nombreEncargado").value;
            const numeroContacto = document.getElementById("numeroContacto").value;
            const FechaDePublicacion = obtenerFechaActual();

            const nuevaPropiedad = {
                id: idPropiedad,
                area,
                bathrooms,
                rooms,
                icon,
                latLng,
                parking,
                price,
                title,
                caracteristicas,
                imageCount,
                imageFolder,
                FechaDePublicacion,
                mostrar,
                encargado,
                numeroContacto,
                nombreEncargado,
                usuario: correoUsuario
            };

            const coleccion = categoria === "venta" ? "ventas" : "alquileres";

            try {
                if (orderedImages.length === 0) {
                    alert("Por favor, selecciona al menos 5 imagenes.");
                    return;
                }

                // Subir las imágenes y guardar la propiedad en Firestore
                await subirImagenes(orderedImages, imageFolder);
                await addDoc(collection(db, coleccion), nuevaPropiedad);

                // Mostrar modal de éxito
                const enlacePropiedad = `https://arribate.com/#id-${idPropiedad}`;

                // Actualiza el contenido del modal
                document.getElementById("nombre-usuario").textContent = `¡La propiedad se agregó con éxito!`;
                document.getElementById("mensaje-adicional").textContent = `${idPropiedad}`;
                document.getElementById("mensaje-modal").textContent = "Enlace de la propiedad generado:";

                // Establece el enlace y lo muestra
                const enlaceElement = document.getElementById("enlace-propiedad");
                enlaceElement.href = enlacePropiedad; // Establece el enlace
                enlaceElement.textContent = enlacePropiedad; // Muestra la URL como texto
                enlaceElement.style.display = "block"; // Muestra el enlace

                // Muestra el modal
                document.getElementById("modal-exito").style.display = "block";
                document.querySelector('.animation-wrapper').style.display = "block";

                // Resetear el formulario y limpiar la lista de imágenes
                document.getElementById("formulario-propiedades").reset();
                document.getElementById("lista-imagenes").innerHTML = "";
                orderedImages = [];

            } catch (e) {
                console.error("Error al guardar los datos: ", e);
                alert("Ocurrió un error al guardar los datos. Revisa la consola para más detalles.");
            } finally {
                // Rehabilitar el botón de envío y restablecer el flag
                isSubmitting = false;
                document.querySelector('.slider-button').disabled = false; // Habilitar el botón de envío nuevamente
            }
        }





        // Manejar el evento de copiar al portapapeles
        document.getElementById("copiar-enlace").addEventListener("click", () => {
            const enlaceInput = document.getElementById("enlace-propiedad");
            const botonCopiar = document.getElementById("copiar-enlace"); // Obtener el botón

            // Obtener el valor del atributo href del enlace
            const enlace = enlaceInput.getAttribute("href");

            // Copiar el enlace al portapapeles
            navigator.clipboard.writeText(enlace)
                .then(() => {
                    // Cambiar el texto del botón a "¡Copiado!"
                    botonCopiar.textContent = "¡Copiado!";

                    // Revertir el texto del botón después de 3 segundos
                    setTimeout(() => {
                        botonCopiar.textContent = "Copiar enlace";
                    }, 3000); // 3000 milisegundos = 3 segundos
                })
                .catch(err => console.error("Error al copiar el enlace: " + err)); // Usar console.error para errores
        });

        // Manejar el cierre del modal
        document.getElementById("cerrar-modal").addEventListener("click", () => {
            // Refrescar la página
            location.reload();
        });






        // Manejando la carga de imágenes y actualizando conteo y peso total
        const lista = document.getElementById("lista-imagenes");

        document.getElementById("imagenes").addEventListener("change", (event) => {
            agregarImagenes(Array.from(event.target.files));
        });

        // Manejar el evento de arrastrar y soltar
        lista.addEventListener("dragover", (event) => {
            event.preventDefault();
        });

        lista.addEventListener("drop", (event) => {
            event.preventDefault();
            const archivos = Array.from(event.dataTransfer.files);
            agregarImagenes(archivos);
        });






        // Función para agregar imágenes desde archivos
        function agregarImagenes(nuevasImagenes) {
            const imageCountInput = document.getElementById("imageCount");
            const imageCountOutput = document.getElementById("imageCountOutput");
            const pesoTotalOutput = document.getElementById("pesoTotalOutput");
            const maxFiles = 32; // Máximo de archivos
            const maxPeso = 50 * 1024 * 1024; // Máximo de 50MB en bytes
            let totalPesoImagenes = 0; // Inicializar el peso total

            // Calcular el nuevo total de imágenes
            const totalImages = orderedImages.length + nuevasImagenes.length;

            // Validar el número de archivos
            if (totalImages > maxFiles) {
                alert(`No puedes cargar más de ${maxFiles} imágenes.`);
                return;
            }

            // Calcular y mostrar el peso total
            nuevasImagenes.forEach(file => {
                totalPesoImagenes += file.size; // Sumar el tamaño de cada archivo
            });

            // Validar el peso total
            if (totalPesoImagenes + orderedImages.reduce((total, img) => total + img.size, 0) > maxPeso) {
                alert("El peso total de las imágenes no puede exceder los 50MB.");
                return;
            }

            // Actualizar el conteo y el peso total en los outputs correspondientes
            imageCountInput.value = totalImages; // Actualizar el input de conteo de imágenes
            imageCountOutput.value = `${totalImages} Imágenes`; // Formato deseado para el conteo
            pesoTotalOutput.value = `${((totalPesoImagenes + orderedImages.reduce((total, img) => total + img.size, 0)) / (1024 * 1024)).toFixed(2)} MB`; // Formato deseado para el peso

            // Añadir las nuevas imágenes a la lista existente y al array de imágenes
            nuevasImagenes.forEach((file, index) => {
                const listItem = document.createElement("li");
                listItem.classList.add("image-preview-item");
                listItem.dataset.index = orderedImages.length + index;

                const img = document.createElement("img");
                img.classList.add("image-preview");
                img.src = URL.createObjectURL(file);
                img.alt = `Imagen ${orderedImages.length + index + 1}`;

                const label = document.createElement("span");
                label.classList.add("image-order-label");
                label.textContent = orderedImages.length + index + 1;

                // Botón de eliminación
                const removeButton = document.createElement("button");
                removeButton.textContent = "X";
                removeButton.style.position = "absolute";
                removeButton.style.top = "5px";
                removeButton.style.right = "5px";
                // Añadiendo los estilos CSS
                removeButton.style.background = "#9d1b1b";
                removeButton.style.border = "none";
                removeButton.style.borderRadius = "5px";
                removeButton.style.fontSize = "15px";
                removeButton.style.color = "#ffffff";
                removeButton.style.cursor = "pointer";

                // Asignar eventos para eliminar la imagen
                const handleRemove = () => {
                    // Restar el tamaño del archivo eliminado
                    totalPesoImagenes -= file.size;
                    orderedImages.splice(orderedImages.indexOf(file), 1);
                    listItem.remove();
                    actualizarOrden();

                    // Actualizar el conteo y el peso total después de eliminar una
                    const updatedTotalImages = orderedImages.length;
                    imageCountOutput.value = `${updatedTotalImages} Imágenes`; // Actualizar el conteo
                    pesoTotalOutput.value = `${((totalPesoImagenes / (1024 * 1024)).toFixed(2))} MB`; // Actualizar el peso total

                    // Actualizar el input de conteo de imágenes
                    imageCountInput.value = updatedTotalImages; // Actualizar el input

                    // Mostrar el mensaje si no hay imágenes
                    const mensaje = document.querySelector(".imagen-upload-mensaje");
                    if (updatedTotalImages === 0 && mensaje) {
                        mensaje.style.display = "block"; // Mostrar el mensaje si no hay imágenes
                    }
                };

                removeButton.onclick = handleRemove;
                removeButton.addEventListener("touchstart", handleRemove); // Agregar soporte para dispositivos táctiles

                listItem.appendChild(img);
                listItem.appendChild(label);
                listItem.appendChild(removeButton);
                lista.appendChild(listItem);
            });
            orderedImages.push(...nuevasImagenes);

            // Ocultar el mensaje de "subir imagen" si hay al menos una imagen
            const mensaje = document.querySelector(".imagen-upload-mensaje");
            if (mensaje) {
                mensaje.style.display = "none"; // Oculta el mensaje
            }

            // Actualiza el input de archivos con las nuevas imágenes
            const inputFile = document.getElementById("imagenes");
            const dataTransfer = new DataTransfer();

            // Agregar las imágenes existentes (incluidas las nuevas)
            orderedImages.forEach(image => {
                dataTransfer.items.add(image);
            });

            // Asignar los archivos al input
            inputFile.files = dataTransfer.files;

            // Mantener la funcionalidad de arrastrar y soltar
            new Sortable(lista, {
                animation: 150,
                onUpdate: () => {
                    const imageElements = lista.querySelectorAll("li");
                    orderedImages = Array.from(imageElements).map((li) => {
                        const originalIndex = li.dataset.index; // Este índice debe reflejar el orden actual
                        return orderedImages[originalIndex]; // Obtener la imagen correspondiente
                    });
                    imageElements.forEach((li, index) => {
                        li.querySelector(".image-order-label").textContent = index + 1; // Actualizar el label
                        li.dataset.index = index; // Actualizar el índice
                    });
                }
            });
        }





        // Función para actualizar la lista visual y el orden después de eliminar
        function actualizarOrden() {
            const lista = document.getElementById("lista-imagenes");
            const elementos = lista.querySelectorAll("li");
            elementos.forEach((elemento, index) => {
                elemento.querySelector(".image-order-label").textContent = index + 1;
                elemento.dataset.index = index;
            });
        }




        // Modifica la función `subirImagenes` para usar `orderedImages`
        async function subirImagenes(imagenes, carpeta) {
            document.getElementById("loading-indicator").style.display = "block";  // Mostrar indicador de carga
            const lista = document.getElementById("lista-imagenes");

            for (let i = 0; i < orderedImages.length; i++) { // Cambia 'imageElements' a 'orderedImages'
                const imagen = orderedImages[i]; // Usa el array 'orderedImages' directamente
                const nombreImagen = `${i + 1}.jpg`; // Nombra la imagen según su índice en 'orderedImages'
                const imagenRef = ref(storage, `${carpeta}/${nombreImagen}`);

                try {
                    // Subir la imagen al almacenamiento
                    await uploadBytes(imagenRef, imagen);
                    console.log(`Imagen ${nombreImagen} subida exitosamente.`);
                } catch (error) {
                    console.error(`Error al subir ${nombreImagen}:`, error);
                    throw new Error(`Error al subir ${nombreImagen}: ${error.message}`);
                }
            }
            document.getElementById("loading-indicator").style.display = "none";  // Ocultar indicador de carga
        }





        // Asignar eventos
        window.onload = () => {
            document.getElementById("categoria").addEventListener("change", actualizarID);
            document.getElementById("tipoPropiedad").addEventListener("change", actualizarID);
            document.getElementById("formulario-propiedades").addEventListener("submit", agregarPropiedad);
            document.getElementById("logout-button").addEventListener("click", cerrarSesion);

            // Escuchar eventos de interacción de mouse, teclado, clics y scroll
            document.addEventListener("mousemove", resetearTemporizador);
            document.addEventListener("keypress", resetearTemporizador);
            document.addEventListener("click", resetearTemporizador);
            document.addEventListener("scroll", resetearTemporizador);

            // Escuchar eventos de interacción de toque en dispositivos móviles
            document.addEventListener("touchstart", resetearTemporizador);
            document.addEventListener("touchmove", resetearTemporizador);
        };
    </script>

</head>

<body>
    <div id="content" style="display: none;">
        <div class="form-admin-add-property-Master">

            <div class="menu-master">
                <button id="logout-button"></button>
                <div class="logonombre">
                    <div class="logo1"></div>
                    <div style="margin-left: 10px;">
                        <h1>ArríbaTe</h1><span>Administrador</span>
                    </div>
                </div>
            </div>


            <div class="form-admin-add-property">

                <div class="portada">
                    <img src="./img/background_formulario_admin_2.png" style="position: absolute;margin: 55px 0px 50px 170px;height: 90px;right: 14px;">
                    <h1 id="welcome-message">HOLA,</h1>
                </div>

                <!-- <div class="light" style="position: relative;background: #1180cb;border-radius: 35px;top: 228px;height: 9px;width: 103px;margin-left: auto;margin-right: auto;box-shadow: 0px 0px 56px 29px rgb(2 74 197);"></div> -->

                <form id="formulario-propiedades">
                    <div class="titulo">Formulario</div>
                    <div class="form-divisor" style="margin: 4px 0;"></div>

                    <label for="categoria">Propósito de la Propiedad:</label>
                    <select id="categoria" required>
                        <option value="">Selecciona</option>
                        <option value="venta">Vender</option>
                        <option value="alquiler">Alquilar</option>
                    </select>
                    <br><br>


                    <label for="tipoPropiedad">Tipo de Propiedad:</label>
                    <select id="tipoPropiedad" required>
                        <option value="">Selecciona</option>
                        <option value="casa">Casa</option>
                        <option value="apartamento">Apartamento</option>
                        <option value="terreno">Terreno</option>
                    </select>
                    <br><br>

                    <label for="idPropiedad">ID de la Propiedad:</label>
                    <input type="text" id="idPropiedad" placeholder="vc10001" readonly="" required=""
                        style="padding: 12px 10px;color: #59eeff; font-size: 17px;">
                    <br><br>

                    <label for="icon">Icono de propiedad:</label>
                    <div id="icon-options" class="icon-buttons">
                        <button type="button" class="icon-button" value="houseIcon" id="icon-casa">
                            <img src="./img/casa4.png" alt="Casa" class="icon-image" style="border-color: #ff5f64;">

                            <p>Casa<br> Estándar</p>
                        </button>
                        <button type="button" class="icon-button" value="buildingIcon" id="icon-apartamento">
                            <img src="./img/apartamento_1.png" alt="Apartamento" class="icon-image"
                                style="border-color: #1090e7;">
                            <p>Apartamento<br> Estándar</p>
                        </button>
                        <button type="button" class="icon-button" value="landIcon" id="icon-terrero">
                            <img src="./img/solar2.png" alt="Terreno" class="icon-image" style="border-color: #59a739;">
                            <p>Terreno<br> Estándar</p>
                        </button>
                    </div>
                    <input type="hidden" id="icon" name="icon" required>


                    <div class="form-divisor"></div> <!-- Divisor -->

                    <label for="title">Título de la Publicación:</label>
                    <input type="text" id="title" placeholder="36 caracteres max." maxlength="36" required>
                    <br><br>

                    <label for="price">Precio de la Propiedad:</label>
                    <div class="input-precio">

                        <input type="text" id="price" placeholder="Cantidad en peso (RD$)" required
                            oninput="formatearPrecio(this)" onblur="validarPrecio(this)">
                        <div class="Tipo-Moneda">RD$</div>
                    </div>

                    <div class="form-divisor"></div> <!-- Divisor -->


                    <label for="rooms">Cantidad de Habitaciones:</label>
                    <div class="input-cantidad">
                        <input type="number" id="rooms" placeholder="0" required
                            style="font-size: 19px;padding: 13px 13px 13px 60px;margin-top: 0px;">
                        <div class="cantidad-img"><img src="./img/habitaciones_1.png"></div>
                    </div>
                    <br><br>

                    <label for="bathrooms">Cantidad de Baños:</label>
                    <div class="input-cantidad">
                        <input type="number" id="bathrooms" placeholder="0" required
                            style="font-size: 19px;padding: 13px 13px 13px 60px;margin-top: 0px;">
                        <div class="cantidad-img"><img src="./img/baños_1.png"></div>
                    </div>
                    <br><br>

                    <label for="parking">Cantidad de Parqueos:</label>
                    <div class="input-cantidad">
                        <input type="number" id="parking" placeholder="0" required
                            style="font-size: 19px;padding: 13px 13px 13px 60px;margin-top: 0px;">
                        <div class="cantidad-img"><img src="./img/parqueos_1.png"></div>
                    </div>
                    <br><br>

                    <label for="area">Metros Cuadrados (m²):</label>
                    <div class="input-cantidad">
                        <input type="number" id="area" placeholder="0" required
                            style="font-size: 19px;padding: 13px 13px 13px 60px;margin-top: 0px;">
                        <div class="cantidad-img"><img src="./img/area_1.png"></div>
                    </div>

                    <div class="form-divisor"></div> <!-- Divisor -->


                    <label for="img">Imagenes de la Propiedad</label>
                    <div class="input-imagenes">
                        <label for="imagenes" class="custom-imagen-upload">
                            <img src="./img/subir-imagen-1.png" alt="Añadir" class="icono-añadir">
                            Añadir imagen
                        </label>
                        <div class="outputs">
                            <output id="imageCountOutput" style="margin-bottom: 2px;">0 Imagen</output>
                            <output id="pesoTotalOutput">0 MB</output>
                        </div>
                        <input type="file" id="imagenes" multiple required accept="image/*" style="display: none;">
                    </div>

                    <div class="lista-imagenes-master">
                        <ul id="lista-imagenes"></ul>
                        <div class="imagen-upload-mensaje">
                            <img src="./img/subir-imagen-1.png" alt="Subir Imagen">
                            <p>O arrastra y suelta las imágenes aquí<br>
                                <span>32 imágenes y 50MB Max.</span>
                            </p>
                        </div>
                    </div>

                    <!-- <label for="marcaDeAgua">¿Agregar marca de agua a las imágenes?</label>
                    <input type="checkbox" id="marcaDeAgua" checked> -->


                    <label for="imageCount" style="display: none;">Número de Imágenes:</label> <!-- hiden-->
                    <input type="number" id="imageCount" readonly style="display: none;"> <!-- hiden-->

                    <label for="imageFolder" style="display: none;">Carpeta de Imágenes:</label> <!-- hiden-->
                    <input type="text" id="imageFolder" readonly style="display: none;"> <!-- hiden-->

                    <label for="piscina" style="display: none;">Piscina:</label> <!-- hiden-->
                    <input type="checkbox" id="piscina" style="display: none;"> <!-- hiden-->

                    <label for="jacuzzi" style="display: none;">Jacuzzi:</label> <!-- hiden-->
                    <input type="checkbox" id="jacuzzi" style="display: none;"> <!-- hiden-->


                    <div class="form-divisor"></div> <!-- Divisor -->

                    <label for="caracteristicas">Detalles de la Propiedad:</label>
                    <div id="editor"></div>
                    <div id="resizer"></div>
                    <input type="hidden" id="caracteristicas" name="caracteristicas" required>

                    <div class="form-divisor"></div> <!-- Divisor -->

                    <!-- <label for="latLng">LatLng (coordenadas):</label>
                    <input type="text" id="latLng" placeholder="Ej: 18.54,-69.90" required> -->

                    <label for="latLng">Ubicación de la Propiedad (Coordenadas):</label>
                    <input type="text" id="latLng" placeholder="Pegar o seleccionar en el mapa" required>
                    <div id="map"></div>


                    <div class="form-divisor"></div> <!-- Divisor -->


                    <label for="mostrar" style="display: none;">¿Mostrar?</label> <!-- hiden-->
                    <input type="checkbox" id="mostrar" name="mostrar" checked style="display: none;"> <!-- hiden-->


                    <div class="tituloEncargado">Encargado de la Propiedad</div>

                    <label for="encargado">Encargado:</label>
                    <select id="encargado" required>
                        <option value="">Selecciona</option>
                        <option value="Dueño">Dueño</option>
                        <option value="Administrador">Administrador</option>
                        <option value="Agente Inmobiliario">Agente inmobiliario</option>
                    </select>
                    <br><br>

                    <label for="nombreEncargado">Nombre del Encargado:</label>
                    <div class="input-numeroContacto">
                        <input type="text" id="nombreEncargado" placeholder="Nombre del encargado" required>
                        <div class="cantidad-img"><img src="./img/nombre_1.png"></div>
                    </div>
                    <br><br>


                    <label for="numeroContacto">Número de Contacto:</label>
                    <div class="input-numeroContacto">
                        <input type="tel" id="numeroContacto" placeholder="Número de contacto" required>
                        <div class="cantidad-img"><img src="./img/phone_1.png"></div>
                    </div>



                    <div class="form-divisor"></div> <!-- Divisor -->



                    <div class="slider-container">
                        <button type="submit" class="slider-button">
                            <div class="button-content">
                                <span class="slider-text">Publicar Propiedad</span>
                                <div class="circle" id="sliderCircle">
                                    <img src="./img/enviar_1.png"
                                        style="margin: 10px 6px 10px 14px;height: 30px;pointer-events: none;">
                                </div>
                            </div>
                        </button>
                    </div>


                    <div class="copyright">
                        <p>© Arríbate 2024</p>
                    </div>


                </form>


                <div id="loading-indicator" style="display: none;">
                    <p>Cargando...</p>
                </div>


                <div id="modal-exito" class="modal">

                    <div class="animation-wrapper">
                        <div class="particle particle-1"></div>
                        <div class="particle particle-2"></div>
                        <div class="particle particle-3"></div>
                        <div class="particle particle-4"></div>
                    </div>

                    <div class="modal-content">
                        <span id="nombre-usuario"></span>
                        <img src="./img/logo_arribate_linea_1.png">
                        <div id="mensaje-adicional"></div>
                        <p id="mensaje-modal"></p>
                        <a id="enlace-propiedad" href="#" target="_blank"></a>
                        <button id="copiar-enlace">Copiar enlace</button>
                        <button id="cerrar-modal">Listo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],        // botones alternados
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }] // listas
                    // No incluyas opciones de encabezados
                ]
            }
        });

        // Cuando se envíe el formulario, guardar el contenido de Quill en el input oculto
        document.getElementById("formulario-propiedades").addEventListener("submit", function () {
            var caracteristicas = document.getElementById("caracteristicas");
            caracteristicas.value = quill.root.innerHTML; // Guardar contenido
        });
    </script>

    <script>
        function formatearPrecio(input) {
            // Eliminar comas existentes
            let valor = input.value.replace(/,/g, '');

            // Verificar si es un número válido
            if (!isNaN(valor) && valor !== '') {
                // Convertir a número y formatear como string con comas
                valor = Number(valor).toLocaleString('en-US');
                input.value = valor; // Asignar el valor formateado al campo de entrada
            }
        }

        function validarPrecio(input) {
            // Eliminar comas y verificar si es un número válido
            let valor = input.value.replace(/,/g, '');
            if (valor === '' || isNaN(valor)) {
                input.value = ''; // Limpiar el campo si no es un número válido
            }
        }

        // Al enviar el formulario, convertir el valor a número
        document.getElementById("formulario-propiedades").addEventListener("submit", function (event) {
            const priceInput = document.getElementById("price");
            const valorSinComas = priceInput.value.replace(/,/g, '');
            priceInput.value = valorSinComas; // Asigna el valor sin comas al campo antes de enviar
        });
    </script>

    <script>

        //script para resaltar la zona de la lista de imagenes al arrastrar imagenes

        document.addEventListener("DOMContentLoaded", () => {
            const lista = document.getElementById("lista-imagenes");

            // Agregar eventos de arrastre
            lista.addEventListener("dragenter", () => {
                lista.classList.add("highlight"); // Agregar clase de resaltado
            });

            lista.addEventListener("dragover", (event) => {
                event.preventDefault(); // Evitar el comportamiento predeterminado
            });

            lista.addEventListener("dragleave", () => {
                lista.classList.remove("highlight"); // Quitar clase de resaltado
            });

            lista.addEventListener("drop", (event) => {
                event.preventDefault(); // Evitar el comportamiento predeterminado
                lista.classList.remove("highlight"); // Quitar clase de resaltado

                const files = event.dataTransfer.files; // Obtener archivos arrastrados
                agregarImagenes(files); // Llamar a la función para agregar imágenes
            });

            // Función para agregar imágenes desde archivos
            function agregarImagenes(nuevasImagenes) {
                // Aquí va tu implementación existente para agregar imágenes
                console.log(nuevasImagenes); // Ejemplo de uso
            }
        });


        //Seleccionar icono de propiedad automaticamente
        document.addEventListener('DOMContentLoaded', () => {
            const propertyTypeSelect = document.getElementById('tipoPropiedad');
            const houseIconButton = document.getElementById('icon-casa');
            const buildingIconButton = document.getElementById('icon-apartamento');
            const landIconButton = document.getElementById('icon-terrero');

            propertyTypeSelect.addEventListener('change', () => {
                if (propertyTypeSelect.value === 'casa') {
                    houseIconButton.click();
                } else if (propertyTypeSelect.value === 'apartamento') {
                    buildingIconButton.click();
                } else if (propertyTypeSelect.value === 'terreno') {
                    landIconButton.click();
                }
            });
        });
        //Seleccionar icono de propiedad automaticamente FIN





        //cambiar tmaño de editor de texto
        const editor = document.getElementById('editor');
        const resizer = document.getElementById('resizer');

        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('active'); // Añadir clase activa al presionar
        });

        resizer.addEventListener('touchstart', (e) => {
            isResizing = true;
            resizer.classList.add('active'); // Añadir clase activa al tocar
            e.preventDefault(); // Prevenir comportamiento táctil por defecto
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const newHeight = e.clientY - editor.getBoundingClientRect().top;

            // Limitar la altura máxima a 450px
            if (newHeight <= 450 && newHeight >= 150) { // Ajusta el mínimo si lo deseas
                editor.style.height = newHeight + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            resizer.classList.remove('active'); // Quitar clase activa al soltar
        });

        document.addEventListener('touchmove', (e) => {
            if (!isResizing) return;

            const touch = e.touches[0]; // Obtener el primer punto de toque
            const newHeight = touch.clientY - editor.getBoundingClientRect().top;

            // Limitar la altura máxima a 450px
            if (newHeight <= 450 && newHeight >= 150) { // Ajusta el mínimo si lo deseas
                editor.style.height = newHeight + 'px';
            }
        });

        document.addEventListener('touchend', () => {
            isResizing = false;
            resizer.classList.remove('active'); // Quitar clase activa al soltar
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>


    <script>
        let map;
        let marker;

        function initMap() {
            // Detectar el ancho de la pantalla y ajustar el nivel de zoom
            const screenWidth = window.innerWidth;
            const initialZoom = screenWidth < 700 ? 7 : 8;

            // Configuración inicial del mapa
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 19.011018, lng: -70.348341 }, // Coordenadas iniciales (Santiago)
                zoom: initialZoom,
            });

            // Inicializa el marcador
            marker = new google.maps.Marker({
                map: map,
                draggable: true, // Permitir arrastrar el marcador
            });


            // Evento para actualizar las coordenadas al hacer clic en el mapa
            map.addListener("click", (event) => {
                updateLatLng(event.latLng);
            });

            // Evento para actualizar las coordenadas al arrastrar el marcador
            marker.addListener("dragend", (event) => {
                updateLatLng(event.latLng);
            });

            // Barra de búsqueda de Google Places
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = "Buscar dirección o lugar en RD";
            input.style = "width: 100%; margin-bottom: 10px;";
            document.getElementById("map").insertAdjacentElement("beforebegin", input);

            // Configuración del Autocomplete con restricciones a República Dominicana
            const options = {
                componentRestrictions: { country: "DO" }, // Limitar a República Dominicana
                fields: ["geometry", "name"], // Campos que quieres obtener en los resultados
            };

            const autocomplete = new google.maps.places.Autocomplete(input, options);

            // Vincular Autocomplete al mapa
            autocomplete.bindTo("bounds", map);

            // Evento cuando se selecciona un lugar
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) return;

                // Centrar el mapa y mover el marcador
                map.setCenter(place.geometry.location);
                marker.setPosition(place.geometry.location);
                updateLatLng(place.geometry.location);
            });
        }

        // Función para actualizar las coordenadas en el formulario
        function updateLatLng(latLng) {
            const lat = latLng.lat().toFixed(6);
            const lng = latLng.lng().toFixed(6);
            document.getElementById("latLng").value = `${lat}, ${lng}`;
            marker.setPosition(latLng);
            circle.setCenter(latLng); // Actualiza la posición del círculo
        }

        // Llama a la función para inicializar el mapa cuando cargue la página
        window.onload = () => {
            initMap();
        };
    </script>



    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnl6BmNpeFzqsmxapeB316ZFO4oIQQRZk&libraries=places&callback=initMap"
        async defer></script>



    <script type="text/javascript">
        const sliderCircle = document.getElementById('sliderCircle');
        const sliderButton = document.querySelector('.slider-button');
        const sliderText = document.querySelector('.slider-text');
        const buttonContent = document.querySelector('.button-content');
        let isSliding = false;

        function initializeText() {
            const letters = sliderText.innerText.split('').map(letter => `<span>${letter}</span>`).join('');
            sliderText.innerHTML = letters;
        }

        initializeText();

        sliderCircle.addEventListener('mousedown', startSlide);
        sliderCircle.addEventListener('touchstart', startSlide);
        buttonContent.addEventListener('click', event => event.preventDefault());

        sliderCircle.addEventListener('click', () => {
            const sliderContainer = sliderCircle.parentElement;
            const containerWidth = sliderContainer.offsetWidth;
            const circleWidth = sliderCircle.offsetWidth;
            const left = parseFloat(sliderCircle.style.left) || 0;

            if (left >= containerWidth - circleWidth) {
                sliderButton.click();
                resetSlider();
            }
        });

        function startSlide(event) {
            if (isSliding) return;
            isSliding = true;

            const sliderContainer = sliderCircle.parentElement;
            const containerWidth = sliderContainer.offsetWidth;
            const circleWidth = sliderCircle.offsetWidth;

            const onMove = (e) => {
                const mouseX = e.clientX || e.touches[0].clientX;
                const left = Math.min(Math.max(mouseX - sliderContainer.getBoundingClientRect().left - circleWidth / 2, 0), containerWidth - circleWidth);
                sliderCircle.style.left = `${left}px`;
                sliderButton.style.backgroundColor = left >= containerWidth * 0.9 ? '#29ab4a' : '#006bdb';

                const letterSpans = sliderText.querySelectorAll('span');
                const textWidth = sliderText.offsetWidth;
                const letterWidth = textWidth / letterSpans.length;

                letterSpans.forEach((span, i) => {
                    const letterLeft = (containerWidth / 2) - (textWidth / 2) + (letterWidth * i);
                    const visibility = (left + circleWidth) - letterLeft;

                    span.style.opacity = visibility < 0 ? 1 :
                        visibility < letterWidth ? Math.max(0, 1 - (visibility / letterWidth)) : 0;
                });

                if (left >= containerWidth - circleWidth) {
                    sliderButton.click();
                    resetSlider();
                    e.preventDefault();
                    e.stopPropagation();
                }
            };

            const onEnd = () => {
                if (parseFloat(sliderCircle.style.left) < containerWidth - circleWidth) {
                    resetSlider();
                }
                isSliding = false;
                cleanupEventListeners();
            };

            const cleanupEventListeners = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('touchend', onEnd);
            };

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchmove', onMove);
            document.addEventListener('touchend', onEnd);
        }

        function resetSlider() {
            sliderCircle.style.left = '0px';
            sliderButton.style.backgroundColor = '#006bdb';
            sliderText.querySelectorAll('span').forEach(span => span.style.opacity = 1);
        }

        function handleSubmit(event) {
            event.preventDefault();
            // ... (Aquí iría tu código para manejar el envío del formulario) ...
            return false;
        }




        document.querySelectorAll(".icon-button").forEach(button => {
            button.addEventListener("click", () => {
                // 1. Remover clase "active" de todos los botones
                document.querySelectorAll(".icon-button.active").forEach(btn => {
                    btn.classList.remove("active");
                });

                // 2. Agregar clase "active" al botón clickeado
                button.classList.add("active");

                // 3. Actualizar el valor del input oculto
                document.getElementById("icon").value = button.value;
            });
        });
    </script>


    <script>
        // Función para manejar el cambio en el propósito de la propiedad
        function cambiarTextoLabel() {
            const categoria = document.getElementById("categoria").value;
            const labelPrecio = document.querySelector("label[for='price']");

            if (categoria === "alquiler") {
                labelPrecio.textContent = "Renta de la Propiedad:";
            } else {
                labelPrecio.textContent = "Precio de la Propiedad:";
            }
        }

        // Asignar el evento de cambio al select de categoría
        document.getElementById("categoria").addEventListener("change", cambiarTextoLabel);
    </script>


    <script>
        //JM EDITOR DE TEXTO
        // Función para ocultar elementos y aplicar estilos a la barra de herramientas
        function modificarElementos() {
            // Ocultar elementos con las clases .ql-link, .ql-image, .ql-blockquote
            const elementosOcultar = document.querySelectorAll('.ql-link, .ql-image, .ql-blockquote');
            elementosOcultar.forEach(elemento => {
                elemento.style.display = 'none';
            });

            // Aplicar estilos a los elementos con la clase .ql-toolbar
            const toolbars = document.querySelectorAll('.ql-toolbar');
            toolbars.forEach(toolbar => {
                toolbar.style.borderRadius = '14px 14px 0px 0px';
                toolbar.style.border = 'none';
                toolbar.style.background = '#868fa5';
                toolbar.style.marginTop = '7px';
            });
        }

        // Llama a la función para modificar los elementos al cargar la página
        document.addEventListener('DOMContentLoaded', modificarElementos);
    </script>


</body>

</html>
