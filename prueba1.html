<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Contabilidad - Paris Laundry</title>
  <link rel="stylesheet" href="./css/styles_contabilidad.css">
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
  <style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f0c8e8;
  }

  h1 {
    color: #333;
  }

  .button-list {
    margin-top: 20px;
  }

  .button-list button {
    padding: 10px;
    margin-right: 10px;
    cursor: pointer;
  }

  .transaction-list {
    margin-top: 20px;
  }

  .transaction-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
    background: #fff;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0, 0, 0);
    background-color: rgba(0, 0, 0, 0.4);
    padding-top: 60px;
  }

  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 10px;
  }

  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  .filter {
    margin-top: 20px;
  }

  .filter input {
    padding: 5px;
    margin-right: 10px;
  }

  .summary {
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: #fff;
  }
  </style>
</head>

<body>
    <h1>Dashboard de Contabilidad y Facturación</h1>
  
    <div class="button-list">
      <button id="addTransactionButton">Agregar Transacción</button>
    </div>
  
    <div class="filter">
      <label for="startDate">Desde:</label>
      <input type="date" id="startDate">
      <label for="endDate">Hasta:</label>
      <input type="date" id="endDate">
      <button id="filterButton">Filtrar</button>
    </div>
  
    <div class="summary" id="summary">
      <h2>Resumen</h2>
      <p>Total Ingresos: RD$<span id="totalIncome">0.00</span></p>
      <p>Total Gastos: RD$<span id="totalExpenses">0.00</span></p>
      <p>Balance: RD$<span id="balance">0.00</span></p>
    </div>
  
  
    <h2>Transacciones</h2>
  
    <div class="transaction-list" id="combinedTransactionList"></div>


<!-- Modal para agregar transacción -->
<div id="addTransactionModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h2>Agregar Nueva Transacción</h2>
    <label for="transactionType">Tipo:</label>
    <select id="transactionType">
      <option value="income">Ingreso</option>
      <option value="expense">Gasto</option>
    </select>
    <br>
    <label for="transactionAmount">Monto:</label>
    <input type="number" id="transactionAmount" placeholder="Monto" step="0.01">
    <br>
    <label for="transactionDate">Fecha:</label>
    <input type="date" id="transactionDate">
    <br>
    <label for="transactionDescription">Detalles:</label>
    <textarea id="transactionDescription" placeholder="Descripción de la transacción"></textarea>
    <br><br>
    <button id="submitTransactionButton">Agregar Transacción</button>
  </div>
</div>
  
    <script>
      // Configuración de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDdG-CP2kO3v-zkkjD17Wj028QJvjp54qY",
        authDomain: "paris-laundry.firebaseapp.com",
        projectId: "paris-laundry",
        storageBucket: "paris-laundry.appspot.com",
        messagingSenderId: "1022712814457",
        appId: "1:1022712814457:web:7bddb47ed46bac22c32da8"
      };
  
      // Inicializar Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
  
      const transactionList = document.getElementById("transactionList");
      const invoiceList = document.getElementById("invoiceList");
      const addTransactionModal = document.getElementById("addTransactionModal");
      const closeModal = document.getElementById("closeModal");
      const submitTransactionButton = document.getElementById("submitTransactionButton");
      const filterButton = document.getElementById("filterButton");
      const totalIncomeElement = document.getElementById("totalIncome");
      const totalExpensesElement = document.getElementById("totalExpenses");
      const balanceElement = document.getElementById("balance");
  
 // Cargar transacciones y facturas desde Firestore
 const loadTransactions = () => {
      const combinedTransactions = []; // Array para almacenar transacciones combinadas
      const startDate = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
      const endDate = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;

      let totalIncome = 0;
      let totalExpenses = 0;

      // Cargar transacciones
      let transactionsQuery = db.collection("transacciones").orderBy("date", "desc");

      if (startDate && endDate) {
          transactionsQuery = transactionsQuery.where("date", ">=", startDate).where("date", "<=", endDate);
      }

      transactionsQuery.get()
          .then((snapshot) => {
              snapshot.forEach((doc) => {
                  const data = doc.data();
                  combinedTransactions.push({
                      type: "transaction",
                      amount: data.amount,
                      date: data.date.toDate(),
                      description: data.type === "income" ? "Ingreso" : "Gasto"
                  });
                  if (data.type === "income") {
                      totalIncome += data.amount;
                  } else {
                      totalExpenses += data.amount;
                  }
              });

              // Cargar facturas
              let invoicesQuery = db.collection("facturas").orderBy("timestamp", "desc");

              if (startDate && endDate) {
                  invoicesQuery = invoicesQuery.where("timestamp", ">=", startDate.toISOString()).where("timestamp", "<=", endDate.toISOString());
              }

              return invoicesQuery.get();
          })
          .then((snapshot) => {
              snapshot.forEach((doc) => {
                  const data = doc.data();
                  combinedTransactions.push({
                      type: "invoice",
                      amount: data.total,
                      date: new Date(data.timestamp),
                      description: `Factura - Cliente: ${data.clientName}`
                  });
                  totalIncome += data.total; // Sumar el total de la factura a los ingresos
              });

              // Ordenar las transacciones combinadas por fecha
              combinedTransactions.sort((a, b) => b.date - a.date); // Ordenar de más reciente a más antiguo

              // Limitar a las últimas 10 transacciones
              const lastTenTransactions = combinedTransactions.slice(0, 10);

              // Limpiar la lista antes de cargar
              const combinedTransactionList = document.getElementById("combinedTransactionList");
              combinedTransactionList.innerHTML = "";

              // Mostrar transacciones combinadas
              lastTenTransactions.forEach(item => {
                  const transactionItem = document.createElement("div");
                  transactionItem.classList.add("transaction-item");
                  transactionItem.innerHTML = `
                      <div>
                          ${item.description} - RD$${item.amount.toFixed(2)} - Fecha: ${item.date.toLocaleDateString()}
                      </div>
                  `;
                  combinedTransactionList.appendChild(transactionItem);
              });

              // Actualizar resumen
              updateSummary(totalIncome, totalExpenses);
          });
  };
  
      // Actualizar el resumen
      const updateSummary = (totalIncome, totalExpenses) => {
        totalIncomeElement.textContent = totalIncome.toFixed(2);
        totalExpensesElement.textContent = totalExpenses.toFixed(2);
        balanceElement.textContent = (totalIncome - totalExpenses).toFixed(2);
      };
  
// Agregar una nueva transacción
const addTransaction = () => {
  const type = document.getElementById("transactionType").value;
  const amount = parseFloat(document.getElementById("transactionAmount").value);
  const date = new Date(document.getElementById("transactionDate").value);
  const description = document.getElementById("transactionDescription").value; // Obtener la descripción

  if (!isNaN(amount) && date) {
    db.collection("transacciones").add({
      type,
      amount,
      date,
      description // Agregar la descripción a la transacción
    }).then(() => {
      alert("Transacción agregada correctamente.");
      closeModal.click(); // Cerrar el modal
      document.getElementById("transactionAmount").value = ""; // Limpiar campos
      document.getElementById("transactionDate").value = "";
      document.getElementById("transactionDescription").value = ""; // Limpiar descripción
      loadTransactions(); // Recargar transacciones
    }).catch((error) => {
      console.error("Error al agregar la transacción: ", error);
      alert("Hubo un problema al agregar la transacción.");
    });
  } else {
    alert("Por favor, completa todos los campos correctamente.");
  }
};
  
      // Evento para abrir el modal de agregar transacción
      document.getElementById("addTransactionButton").addEventListener("click", () => {
        addTransactionModal.style.display = "block";
      });
  
      // Evento para cerrar el modal de agregar transacción
      closeModal.addEventListener("click", () => {
        addTransactionModal.style.display = "none";
      });
  
      // Evento para agregar la transacción desde el modal
      submitTransactionButton.addEventListener("click", addTransaction);
  
      // Evento para filtrar transacciones
      filterButton.addEventListener("click", loadTransactions);
  
      // Cargar transacciones y facturas al iniciar
      loadTransactions();
  
      // Cerrar el modal si se hace clic fuera de él
      window.onclick = function (event) {
        if (event.target === addTransactionModal) {
          addTransactionModal.style.display = "none";
        }
      };
    </script>
</body>

</html>
